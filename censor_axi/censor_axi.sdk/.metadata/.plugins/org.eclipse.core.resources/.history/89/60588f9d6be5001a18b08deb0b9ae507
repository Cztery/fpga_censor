/*
 * main.c
 *
 *  Created on: 23.08.2020
 *      Author: piotr
 */

#include "xparameters.h"
#include "censor_ip.h"

/**************************** user definitions ********************************/
#define CHANNEL 1

//Censor processor base addres redefinition
#define CENSOR_BASE_ADDR XPAR_CENSOR_IP_0_S00_AXI_BASEADDR

//Censor processor registers' offset redefinition
#define INPUT_READY_REG_OFFSET	CENSOR_IP_S00_AXI_SLV_REG0_OFFSET
#define INPUT_CHAR_REG_OFFSET	CENSOR_IP_S00_AXI_SLV_REG1_OFFSET
#define OUTPUT_READY_REG_OFFSET	CENSOR_IP_S00_AXI_SLV_REG2_OFFSET
#define OUTPUT_CHAR_REG_OFFSET	CENSOR_IP_S00_AXI_SLV_REG3_OFFSET
#define RESULT_REG_SIN(param)	((u32)param & (u32)(0x00000FFF))
#define RESULT_REG_COS(param)	(((u32)param & (u32)(0x0FFF0000)) >> 16 )
/***************************** Main function *********************************/
int main(){
	char input_string[10] = {'A', 'l', 'a', ' ', 'm', 'a', ' ', 'k', 'o', 'd'};
	char char_out;
	int i = 0;
	u32 result;

	//Send 1 at in_ready to start Censor processor
	CENSOR_IP_mWriteReg(CENSOR_BASE_ADDR, INPUT_READY_REG_OFFSET, 1);
	CENSOR_IP_mWriteReg(CENSOR_BASE_ADDR, INPUT_READY_REG_OFFSET, 0);

	while(1){
	//Send characters at char_in register
		for(int i=0; i<10; i++)
			CENSOR_IP_mWriteReg(CENSOR_BASE_ADDR, INPUT_CHAR_REG_OFFSET, input_string[i]);

		//Wait for out_ready
		while( (CORDIC_IP_mReadReg(CENSOR_BASE_ADDR, OUTPUT_READY_REG_OFFSET) & 0x01) == 0);

		//Get output char
		result = CORDIC_IP_mReadReg(CENSOR_BASE_ADDR, RESULT_REG_OFFSET);

		//Extract sin and cos from 32-bit register data
//		sin = RESULT_REG_SIN( result );	//TODO
//		cos = RESULT_REG_COS( result );
	}
	//Send to GPIO
//	XGpio_DiscreteWrite(&sinGpio, CHANNEL, sin);
//	XGpio_DiscreteWrite(&cosGpio, CHANNEL, cos);

	/* Failure or end trap */
	FAILURE:
		while(1);
}
